name: II agent build template

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment name (dev, prod, staging)'
        required: true
        type: string
      image_tag:
        description: 'Docker image tag'
        required: true
        type: string
    secrets:
      GCP_SA_KEY:
        required: true
      FRONTEND_ENV:
        required: true

env:
  REGION: us-central1
  REGISTRY: us-central1-docker.pkg.dev
  REPO_PATH: backend-alpha-97077/iirepo

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker $REGISTRY --quiet
          echo "Docker authentication configured for $REGISTRY"

      - name: Create frontend .env file
        run: echo "${{ secrets.FRONTEND_ENV }}" > frontend/.env.local

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/frontend/Dockerfile
          push: true
          provenance: false
          tags: |
            ${{ env.REGISTRY }}/${{ env.REPO_PATH }}/ii-agent-${{ inputs.environment }}-fe:${{ inputs.image_tag }}
            ${{ env.REGISTRY }}/${{ env.REPO_PATH }}/ii-agent-${{ inputs.environment }}-fe:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.REPO_PATH }}/ii-agent-${{ inputs.environment }}-fe:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.REPO_PATH }}/ii-agent-${{ inputs.environment }}-fe:buildcache,mode=max

      - name: Clean up frontend .env file
        if: always()
        run: rm -f frontend/.env.local

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/backend/Dockerfile
          push: true
          provenance: false
          tags: |
            ${{ env.REGISTRY }}/${{ env.REPO_PATH }}/ii-agent-${{ inputs.environment }}:${{ inputs.image_tag }}
            ${{ env.REGISTRY }}/${{ env.REPO_PATH }}/ii-agent-${{ inputs.environment }}:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.REPO_PATH }}/ii-agent-${{ inputs.environment }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.REPO_PATH }}/ii-agent-${{ inputs.environment }}:buildcache,mode=max

      - name: Output build information
        run: |
          echo "Environment: ${{ inputs.environment }}"
          echo "Image Tag: ${{ inputs.image_tag }}"
          echo "Images built:"
          echo "  - ${{ env.REGISTRY }}/${{ env.REPO_PATH }}/ii-agent-${{ inputs.environment }}-fe:${{ inputs.image_tag }}"
          echo "  - ${{ env.REGISTRY }}/${{ env.REPO_PATH }}/ii-agent-${{ inputs.environment }}-fe:latest"
          echo "  - ${{ env.REGISTRY }}/${{ env.REPO_PATH }}/ii-agent-${{ inputs.environment }}:${{ inputs.image_tag }}"
          echo "  - ${{ env.REGISTRY }}/${{ env.REPO_PATH }}/ii-agent-${{ inputs.environment }}:latest"
